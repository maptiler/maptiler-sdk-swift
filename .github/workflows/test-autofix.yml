name: PR Tests and Auto-Fix

on:
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-autofix-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  test:
    name: Run Swift tests
    # Run only for bot-authored PRs (more robust than checking a specific login)
    if: ${{ github.event.pull_request.user.type == 'Bot' || github.actor == 'github-actions[bot]' }}
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Up Swift
        uses: maxim-lobanov/setup-xcode@592f3a0ea6269bc3452fd67ae771c3174f6d01cf
        with:
          xcode-version: '16.2'

      - name: Select Xcode
        run: sudo xcode-select --switch /Applications/Xcode_16.2.app

      - name: Verify Swift Version
        run: swift --version

      - name: Verify Xcode version
        run: xcodebuild -version

      - name: Verify Active Swift Toolchain version
        run: xcrun swift -version

      - id: tests
        name: Run tests (capture log)
        continue-on-error: true
        run: |
          set -o pipefail
          {
            set -u
            echo "Attempt 1: run tests on iPhone 16"
            if xcrun xcodebuild test \
              -sdk iphonesimulator \
              -scheme MapTilerSDK \
              -destination 'platform=iOS Simulator,name=iPhone 16' \
              -retry-tests-on-failure -test-iterations 3; then
              exit 0
            fi
            
            echo "First attempt failed; installing iOS runtime, then retrying on iPhone 17..."
            sudo xcodebuild -downloadPlatform iOS
            xcrun simctl list runtimes | grep iOS || true
            
            echo "Attempt 2: run tests on iPhone 17"
            xcrun xcodebuild test \
              -sdk iphonesimulator \
              -scheme MapTilerSDK \
              -destination 'platform=iOS Simulator,name=iPhone 17' \
              -retry-tests-on-failure -test-iterations 3
          } 2>&1 | tee xcodebuild-test.log

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-test-log
          path: xcodebuild-test.log

      - id: set_status
        name: Set job output if tests failed
        run: |
          if [ "${{ steps.tests.outcome }}" = "failure" ]; then
            echo "tests_failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "tests_failed=false" >> "$GITHUB_OUTPUT"
          fi
    outputs:
      tests_failed: ${{ steps.set_status.outputs.tests_failed }}

  autofix:
    name: Run Gemini auto-fix on failures
    needs: test
    # Only attempt auto-fix when tests_failed output is true and PR is bot-authored
    if: ${{ needs.test.outputs.tests_failed == 'true' && (github.event.pull_request.user.type == 'Bot' || github.actor == 'github-actions[bot]') }}
    runs-on: macos-latest

    steps:
      - name: Checkout PR head branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Set Up Swift
        uses: maxim-lobanov/setup-xcode@592f3a0ea6269bc3452fd67ae771c3174f6d01cf
        with:
          xcode-version: '16.2'

      - name: Select Xcode
        run: sudo xcode-select --switch /Applications/Xcode_16.2.app

      - name: Verify Swift Version
        run: swift --version

      - name: Verify Xcode version
        run: xcodebuild -version

      - name: Verify Active Swift Toolchain version
        run: xcrun swift -version

      - name: Download failing test log
        uses: actions/download-artifact@v4
        with:
          name: xcode-test-log
          path: .

      - id: failure_excerpt
        name: Prepare failure excerpt for prompt
        run: |
          # Extract a concise failure summary to keep prompt focused
          {
            echo 'FAILURE_EXCERPT<<EOF'
            if command -v gsed >/dev/null 2>&1; then SED=gsed; else SED=sed; fi
            # Try to capture failing tests sections and error lines; fallback to last 400 lines
            (grep -E "(\b(error|failed|Failing tests)\b)" -n xcodebuild-test.log || tail -n 400 xcodebuild-test.log) | $SED -e 's/\r$//'
            echo EOF
          } >> "$GITHUB_ENV"

      - name: Symlink agents
        run: ln -s .github/copilot-instructions.md GEMINI.md
      - name: Symlink ignore
        run: ln -s .github/.copilot-ignore .geminiignore

      - name: Load agent directives
        id: agent_directives
        run: |
          echo "directives<<EOF" >> "$GITHUB_OUTPUT"
          cat .github/copilot-instructions.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - id: guard
        name: Guard against repeated auto-fix attempts
        run: |
          last_msg="$(git log -1 --pretty=%s)"
          if echo "$last_msg" | grep -qi '^ci: auto-fix for failing tests'; then
            echo "already=true" >> $GITHUB_OUTPUT
            echo "Most recent commit is an auto-fix; skipping run."
          else
            echo "already=false" >> $GITHUB_OUTPUT
          fi

      - name: 'Run Gemini CLI'
        if: ${{ steps.guard.outputs.already == 'false' }}
        id: 'run_gemini'
        uses: 'google-github-actions/run-gemini-cli@v0' # ratchet:exclude
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN || github.token }}'
          IS_PULL_REQUEST: '${{ !!github.event.pull_request }}'
          REPOSITORY: '${{ github.repository }}'
          AGENT_DIRECTIVES: '${{ steps.agent_directives.outputs.directives }}'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}'
          google_api_key: '${{ secrets.GOOGLE_API_KEY }}'
          use_gemini_code_assist: '${{ vars.GOOGLE_GENAI_USE_GCA }}'
          gemini_debug: '${{ fromJSON(vars.DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}'
          gemini_model: '${{ vars.GEMINI_MODEL }}'
          settings: |-
            {
              "maxSessionTurns": 50,
              "telemetry": {
                "enabled": ${{ vars.GOOGLE_CLOUD_PROJECT != '' }},
                "target": "gcp"
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server"
                  ],
                  "includeTools": [
                    "add_issue_comment",
                    "get_issue",
                    "get_issue_comments",
                    "list_issues",
                    "search_issues",
                    "create_pull_request",
                    "get_pull_request",
                    "get_pull_request_comments",
                    "get_pull_request_diff",
                    "get_pull_request_files",
                    "list_pull_requests",
                    "search_pull_requests",
                    "create_branch",
                    "create_or_update_file",
                    "delete_file",
                    "fork_repository",
                    "get_commit",
                    "get_file_contents",
                    "list_commits",
                    "push_files",
                    "search_code"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              },
              "coreTools": [
                "read_file",
                "write_file",
                "replace",
                "list_directory",
                "glob",
                "search_file_content",
                "run_shell_command(cat)",
                "run_shell_command(echo)",
                "run_shell_command(grep)",
                "run_shell_command(head)",
                "run_shell_command(tail)",
                "run_shell_command(swiftlint)",
                "run_shell_command(xcrun)",
                "run_shell_command(xcodebuild)"
              ]
            }
          prompt: |-
            Swift tests failed on this PR. Analyze the failure log and make minimal, high-quality code changes that fix the issues while preserving intended behavior and style.
            
            Constraints:
            - Only modify code relevant to the failures.
            - Keep changes small and focused.
            - Maintain SwiftLint style; prefer idiomatic Swift.
            - Do not alter unrelated workflows or config.

            Failure log excerpt:
            ${{ env.FAILURE_EXCERPT }}

      - name: SwiftLint fix
        if: ${{ steps.guard.outputs.already == 'false' }}
        run: swiftlint --fix --quiet || true

      - name: Commit changes if any
        if: ${{ steps.guard.outputs.already == 'false' }}
        run: |
          git add -A
          git commit -m "ci: auto-fix for failing tests" || echo "No changes to commit"

      - name: Push changes to PR branch
        if: ${{ steps.guard.outputs.already == 'false' }}
        run: |
          # Only push if there are new commits
          if [ -n "$(git log origin/${{ github.event.pull_request.head.ref }}..HEAD)" ]; then
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
          else
            echo "No changes to push"
          fi
